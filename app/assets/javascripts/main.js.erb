Track = function (trackId){
  var currentTrack = '';

  SC.initialize({
    client_id: '<%= ENV['CLIENT_ID'] %>'
  });

  SC.stream('tracks/' + trackId)
    .then(function(sound) {
    if (sound.options.protocols[0] === 'rtmp') {
      sound.options.protocols.splice(0, 1);
    }
    currentTrack = sound;
    currentTrack.play();
    currentTrack.on('finish', function(sound) {
      currentPlayingTrack.stop();
      currentTrack = rotation.nextTrack();
      currentPlayingTrack = new Track(currentTrack);
      $('#play-pause').children('img').attr('src','assets/pause.png');
      playing = true;
    })
    $('#play-pause').children('img').attr('src','assets/pause.png');
    playing = true;
  });

  this.play = function() {
    currentTrack.play();
    playing = true;
  };

  this.pause = function() {
    currentTrack.pause();
    playing = false;
  };

  this.stop = function() {
    currentTrack.pause();
    playing = false;
  };
};

Rotation = function(tracks) {
  randomNumber = Math.floor((Math.random() * tracks.length));
  
  currentTrack = tracks[randomNumber];

  this.currentTrack = function () {
    $('.track-name').html(currentTrack.title);
    $('.track-name').attr('href', currentTrack.permalink_url);
    $('#soundcloud').attr('href', currentTrack.permalink_url);
    return currentTrack;
  };

  this.nextTrack = function () {
    randomNumber = Math.floor((Math.random() * tracks.length));
    nextTrack = tracks[randomNumber];
    nextTrackId = nextTrack.id;
    currentTrack = nextTrackId;
    $('.track-name').html(nextTrack.title);
    $('.track-name').attr('href', nextTrack.permalink_url);
    $('#soundcloud').attr('href', nextTrack.permalink_url);
    return currentTrack
  };
};

$(document).ready(function() {
  
  fetchTracks = function () {
    var request = $.ajax({
      url: '/radio'
    });
    request.then(function(response) {
      tracks = response.tracks;
      rotation = new Rotation(tracks);
      currentTrack = rotation.currentTrack();
      currentPlayingTrack = new Track(currentTrack.id);
    }) 
  };

  playing = false;

  $('.radio').on('click', '#play-pause', function(event) {
    event.preventDefault();
    if (playing === true) {
      currentPlayingTrack.pause();
      $(this).children('img').attr('src','assets/play.png');
    } else {
      currentPlayingTrack.play();
      $(this).children('img').attr('src','assets/pause.png');
    }
  });

  $('.radio').on('click', '#next-song', function(event) {
    event.preventDefault();
    currentPlayingTrack.stop();
    currentTrack = rotation.nextTrack();
    currentPlayingTrack = new Track(currentTrack);
    $('#play-pause').children('img').attr('src','assets/pause.png');
  });

  fetchTracks();
  
  $('.navbar-nav').on('click', 'li', function(event) {
    event.preventDefault();
    var $url = $(this).children('a').attr('href');
    var request = $.ajax({
      url: $url
    });
    request.done(function(response) {
      $('#body-container').html(response);
    });
  });
});
